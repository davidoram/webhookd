name: LoadTest

# Note; this workflow is not triggered by any event, but can be manually triggered
#       It only works on the 'main' branch 
#       See https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow
on: workflow_dispatch

jobs:
  check-permissions:
    runs-on: ubuntu-latest

    steps:
# Check for write permission
    - name: Check user permission
      id: check
      uses: scherermichael-oss/action-has-permission@master
      with:
        required-permission: write
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Use the output from the `check` step
    - name: Run only if user has sufficient permissions
      if: steps.check.outputs.has-permission
      run: echo "Congratulations! Your permissions to access the repository are sufficient."
    - name: Run only if user has NOT sufficient permissions
      if: "! steps.check.outputs.has-permission"
      run: |
        echo "Sorry! Your permissions are insufficient."
        exit 1
  docker:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
  
      - name: Build Docker images
        run: make dockerbuild
            
      - name: Generate test data
        run: make test
  
      - name: Start load test containers
        run: make load-test-setup
  

      - name: Stop containers
        if: always()
        run: docker-compose -f "docker-compose.yml" down      